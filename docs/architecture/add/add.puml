@startuml
title kitcat add â€“ Activity Diagram

start

:User runs `kitcat add [paths | --all]`;

if ("--all flag set?") then (yes)

  :Load index;
  :Load ignore patterns;
  :Initialize filesInWorkDir map;

  :Walk working directory recursively;

  if ("Unsafe path?") then (yes)
    :Skip path;
  endif

  if ("Inside .kitcat?") then (yes)
    :Skip directory;
  endif

  if ("Is directory?") then (yes)
    :Continue walk;
  endif

  if ("Ignored file?") then (yes)
    :Skip file;
  endif

  :Hash file contents;
  :Store object;
  :Update index entry;
  :Mark file as seen;

  :Detect deleted files;
  :Remove deleted entries from index;

else (no)

  :For each provided path;
  :Clean path;

  if ("Safe path?") then (no)
    :Abort with error;
  endif

  :Ensure repository exists;
  :Hash file contents;
  :Store object;

  :Load index;

  if ("Already tracked with same hash?") then (yes)
    :Skip update;
  else (no)
    :Update index entry;
  endif

endif

:Write index to disk;
stop

@enduml
